\section{Reactive Approaches}
In addition to proactive approaches to helping prevent active BGP routing attacks, we have also taken a reactive approach.  In the case that an attack is happening, we can detect it using a live monitoring framework.

\subsection{A Live Monitoring Framework for Tor}
A possible countermeasure against routing attacks on the Tor network is attack 
detection and user notification.  Routing authorities then know which relays are 
being hijacked and/or intercepted, and can make routing decisions accordingly.  
Real world routing attacks are almost always short-lived\annie{add citation}, which allows 
routing authorities to suspend use of hijacked/intercepted relays until enough 
time has passed to use them again.

The live monitoring framework aims at detecting suspicious routing attacks that affect Tor relays, and reacts correspondingly to alert Tor clients of the scenario. The monitoring framework consists of two parts: BGP monitoring and Traceroute monitoring.\\

\subsubsection{Data} 
\label{sec:data}
Our framework requires information about current Tor relays.  The Tor Project releases up-to-date information about current running relays every hour. Our system automatically fetches this consensus data once it's updated. We focus on guard relays and exit relays, which reside at the two ends of the communication path and can easily be the target of an adversary. Further more, since we focus on AS-level adversaries, it is unnecessary to monitor each individual relay by its IP address. Instead, we monitor the /24 prefixes which contain Tor guard and exit relays. Note that, there is no need to monitor a more specific prefix than /24, since generally /24 is the longest prefix accepted in BGP announcement.

The framework also uses IP to ASN mappings from Team Cymru \cite{teamcymru}.  This is used in both the BGP monitoring component and Traceroute monitoring component to find the ASes that contain Tor relays, as well as map traceroutes (IP-level paths) to AS-level paths.  One caveat of using Team Cymru is the potential inaccuracy and incompleteness of the data \annie{should we mention anything else about Team Cymru re accuracy/completeness?}.

%Thus, we construct a live monitoring database which is being updated every hour with latest Tor relay data. The table contains the following fields:
%\begin{center}
%\begin{tabular}{ p{8mm} | p{1.4cm} | p{1.3cm} | p{1.3cm} | p{1.3cm}}
 % \hline			
  %$/24$ Prefix & Total Bandwidth & Number of Guards & Number of Exits & Timestamp \\
  %\hline  
%\end{tabular}
%\label{tab:relayinfo}
%\end{center}
%Each /24 prefix that contains any guard/exit relays will have one entry in the table, and the list of /24 prefixes will be used for our BGP and Traceroute monitoring frameworks, which we describe in the following. 

\subsubsection{BGP Monitoring Framework} 
\label{sec:bgp}
The BGP Monitoring framework monitors the control plane of internet routing. We collect live BGP updates in combination with the latest Tor relay data. We monitor all the /24 prefixes we obtain, as described in Section \ref{sec:data}. We check if any activity related with the prefixes exhibit any anomaly. These anomalies can be detected by applying heuristics, such as the amount of time that a BGP path is used or the frequency that a path is announced; if certain anomalies fall under a threshold for a given heuristic, they should be flagged as potential attacks. This analysis will require saving inactive relay BGP info for some period of time.  This framework helps:

\begin{itemize}
\item Identify suspicious prefix announcements.
\item Differentiate between potential attacks and ``normal'' behavior, such as multiple origin AS conflicts, backup paths, etc~\cite{zhao2001analysis}.
\end{itemize}

We use Team Cymru \cite{teamcymru} to obtain AS ownership of prefixes. Some prefixes are owned by an organization with multiple AS numbers, so we take this into consideration and store all AS origins of these prefixes. If we observe any change in AS paths, we will first check if the prefix has multiple AS origins, and if so, as long as the new origin AS also owns the prefix, then it would not be seen as an attack. 

The implementation of the BGP Monitoring framework is based on BGP Stream~\cite{bgpstream}.  We analyze the live stream of BGP announcements and withdrawals, focusing just on the prefixes that contain a Tor guard or exit.  We monitor the prefixes that are reported through Team Cymru, as well as the /24 that contains each relay; we do this in order to detect sub-prefix hijack attacks -- we must monitor longer prefixes in addition to the reported prefix.  

Our analysis involves three different detection techniques:

\begin{enumerate}
\item Origin AS check.  We collect the origin AS in the live BGP update and compare it to the owner AS reported by Team Cymru.  If these don't match up, then we flag the update (and prefix) as a suspicious update, otherwise we ignore it. 
\item Frequency heuristic.  Routing attacks can be 
characterized by an AS announcing a path once (or extremely rarely) to a prefix 
that it does not own.  The frequency heuristic detects attacks that exhibit this behavior. 
It measures the frequency of each AS that originates a given prefix; if the frequency is 
lower than a specified threshold, then it could be a potential hijack attack.
\item Time heuristic.  Most known attacks 
last a relatively short amount of time. The time heuristic measures the amount of time each 
path to a prefix is announced for; if the amount of time is extremely small (below a specified threshold), 
then there is the possibility of it being a routing attack. 
\end{enumerate}  

\subsubsection{Traceroute Monitoring Framework} 
The Traceroute Monitoring Framework monitors the data plane of Internet routing, i.e., how packets travel through the Internet in reality. The traceroute monitoring framework is used as a verification mechanism if the BGP monitoring framework flags anomalous behavior. There may be many false positives in detecting hijack attacks due to the nature of BGP.  With many false positives, the traceroute monitoring framework will be used often for verification.

Our Traceroute monitoring framework retrieves updated Tor relay data hourly from the Tor consensus as described in Section \ref{sec:data}. Since running large numbers of continuous traceroutes to relay IP addresses may create unnecessary extra traffic on the Tor network, we run traceroutes only when necessary.  When there is suspicious activity report by the BGP monitoring framework, the traceroute monitoring framework can be ``triggered'' to target the prefix in the suspicious announcement to verify or disregard the anomaly. If we detect any anomaly from the BGP monitoring framework, we will immediately send traceroutes to the suspicious prefixes to verify whether there is truly a path change happening on the data plane to the Tor relays. 

Prior research has studied the vulnerabilities of traceroute; an attacker can manipulate responses to traceroute.  Our framework runs traceroutes from approximately 60 different locations; a consensus can then be taken among the traceroutes.  Therefore, our framework is resistant to attackers that can manipulate a small number of traceroutes.  \annie{should we mention anything else about this type of potential attacker?}

%\begin{itemize}
%\item Selectively monitor relays of interest.\\
%A /24 prefix can be evaluated based on several factors: (1) total combined bandwidth of Tor relays it covers, denoted as $b_i$ for prefix $i$; (2) total number of guard relays it covers, denoted as $g_i$; (3) total number of exit relays it covers, denoted as $e_i$; and (4) resilience of the prefix to BGP hijack/interception attacks, denoted as $r_i$. These factors can make the prefix an attractive target to adversaries. Using these factors, we want to formulate the overall security of the system as following, and the goal is to find the monitoring frequency $f_i$ for each relay $i$ that maximizes the overall security of the network. \\
%\begin{align}
%\max \sum_{i=1}^N & \frac {\log {(f_i + 1)}} {b_i + g_i + e_i + r_i}\\
%\text{s.t. } &\sum_{i=1}^N f_i \leq F\\
%&0 < f_i \leq M, \forall i
%\end{align}
%$N$ is the total number of prefixes we want to monitor, $F$ is the constraint on total number of traceroutes we can send from each Planetlab node per day, and $M$ is the constraint on total number of traceroutes needed for each prefix. Given the solution, we use a collection of Planetlab nodes located in different ASes to send traceroutes to the prefix at its frequency rate. 
%A /24 prefix can be evaluated based on (1) total combined bandwidth of Tor guard/exit relays it covers, and (2) total number of guard/exit relays it covers. These two factors can make the prefix an attractive target to adversaries due to the high amount of traffic it could be handling. Thus, we rank all the /24 prefixes by combining its cumulative bandwidth and number of relays, and selectively monitor the top 50 prefixes when there is no anomaly triggered by BGP monitoring framework. 
%We use PlanetLab nodes that are located in different ASes (updated daily to get the latest list of PlanetLab nodes) to send traceroute requests to the prefixes hourly. We compare the current traceroute paths to previously recorded traceroute paths to detect any anomaly, which will be described in more details in the following. 

%\item Monitoring target prefixes triggered by BGP.\\
%If we detect any anomaly from the BGP monitoring framework, we will immediately send traceroutes to the suspicious prefixes to verify whether there is truly a path change happening on the data plane to the Tor relays. 

%\item Detecting anomaly from Traceroutes\\
%Even when there is no suspicious activity reported by BGP monitoring, it is also possible we detect anomaly from our selective traceroute monitoring. 
%We keep track of the past traceroute monitoring paths in a database table, as following:
%\begin{center}
%\begin{tabular}{ p{9mm} | p{9mm} | p{6mm} | p{1.2cm} | p{1.2cm}} %| p{8mm}}
%  \hline			
%  Source Prefix & Dest Prefix & AS Path & Time Created & Time Last Updated \\ %& Current \\
%  \hline  
%\end{tabular}
%\label{tab:pathinfo}
%\end{center}
%Note that, instead of recording every hop in the traceroute path, we first convert the IP to ASN using Team Cymru whois server (citation here), and eliminate any duplicated intra-AS hops to obtain the final AS-level paths. With this table, we will be able to compare the current AS path with \emph{any} previously seen AS paths to detect any path changes. If there is any anomaly detected, we will log a warning and make it public. 

%\end{itemize}

\subsection{Framework Evaluation}
The BGP monitoring framework has been running since Febuary 4th, 2016; for the purposes of our evaluation, we analyze data collected between February 4th, 2016 and February 16th, 2016.  It has recorded 2,248 updates that include a Tor guard or exit relay, and 28 announcements that include a Tor relay and have an origin AS that disagrees with Team Cymru's data.  After implementing the frequency and time heuristics described in Section \ref{sec:bgp}, we applied them to the data collected between February 4th and 16th.  The origin AS check occurs in real-time as part of the BGP monitoring framework.  For our analysis, we assume that there were no hijack attacks on the Tor network during the time we collected data.  

\subsubsection{Origin AS Check Evaluation}

\annie{manual check with past tor updates}

\subsubsection{Frequency Heuristic Evaluation}

\begin{table}[h]
\begin{center}
    \begin{tabular}{| l | l |}
    \hline
    Threshold & False Positive Percentage \\ \hline \hline
    .001 & 0.00\% \\ \hline
    .002 & 0.00\% \\ \hline
    .003 & 0.00\% \\ \hline
    .004 & 0.00\% \\ \hline
    .005 & 2.63\% \\ \hline
    .006 & 4.29\% \\ \hline
    .007 & 4.29\% \\ \hline
    .008 & 4.29\% \\ \hline
    .009 & 5.96\% \\ \hline
    .01 & 9.90\% \\
    \hline
    \end{tabular}
\end{center}
\end{table}

\subsubsection{Time Heuristic}

\begin{table}[h]
\begin{center}
    \begin{tabular}{| l | l |}
    \hline
    Threshold & False Positive Percentage \\ \hline \hline
    .00000001 & 0.00\% \\ \hline
    .0000001 & 0.44\% \\ \hline
    .000001 & 1.67\% \\ \hline
    .00001 & 2.02\% \\ \hline
    .0001 & 2.28\% \\ \hline
    .001 & 2.28\% \\ \hline
    .01 & 5.26\% \\
    \hline
    \end{tabular}
\end{center}
\end{table}

%Our frequency heuristic was tuned to a threshold of .01\%, meaning that any prefix announced by an AS with a frequency lower than .01\% of all announcements would be flagged as suspicious.  This resulted in approximately 40 suspicious AS - prefix pairs.  Our time heuristics was set to the same threshold, and resulted in approximately 60 suspicious pairs.  This indicates that our heuristics need to be tuned for more precise and accurate results. \annie{We will add more results here.}
